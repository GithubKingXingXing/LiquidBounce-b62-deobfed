
package net.ccbluex.liquidbounce.features.module.modules.exploit;

import javax.vecmath.Vector3d;
import net.ccbluex.liquidbounce.event.events.PacketEvent;
import net.ccbluex.liquidbounce.event.events.MoveEvent;
import net.minecraft.client.renderer.entity.RenderManager;
import net.minecraft.client.renderer.GlStateManager;
import net.minecraft.util.AxisAlignedBB;
import net.ccbluex.liquidbounce.utils.render.RenderUtils;
import java.awt.Color;
import org.lwjgl.opengl.GL11;
import net.minecraft.block.BlockAir;
import net.ccbluex.liquidbounce.event.events.Render3DEvent;
import net.ccbluex.liquidbounce.event.EventTarget;
import net.minecraft.client.entity.EntityPlayerSP;
import net.ccbluex.liquidbounce.utils.MovementUtils;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.ccbluex.liquidbounce.utils.PathUtils;
import net.minecraft.entity.Entity;
import net.minecraft.network.play.client.C0BPacketEntityAction;
import net.minecraft.block.material.Material;
import net.ccbluex.liquidbounce.utils.block.BlockUtils;
import org.lwjgl.input.Mouse;
import net.ccbluex.liquidbounce.utils.misc.MouseUtils;
import net.ccbluex.liquidbounce.event.events.UpdateEvent;
import net.ccbluex.liquidbounce.utils.ChatUtils;
import joptsimple.internal.Strings;
import net.minecraft.client.audio.ISound;
import net.minecraft.client.audio.PositionedSoundRecord;
import net.minecraft.util.ResourceLocation;
import net.ccbluex.liquidbounce.features.command.Command;
import net.ccbluex.liquidbounce.LiquidBounce;
import java.util.ArrayList;
import net.minecraft.util.MovingObjectPosition;
import net.minecraft.util.BlockPos;
import net.minecraft.network.Packet;
import java.util.List;
import net.ccbluex.liquidbounce.utils.timer.TickTimer;
import net.ccbluex.liquidbounce.valuesystem.types.ListValue;
import net.ccbluex.liquidbounce.features.module.ModuleCategory;
import net.ccbluex.liquidbounce.features.module.ModuleInfo;
import net.ccbluex.liquidbounce.features.module.Module;

@ModuleInfo(name = "Teleport", description = "Allows you to teleport around.", category = ModuleCategory.EXPLOIT)
public class Teleport extends Module
{
    private final ListValue modeValue;
    private final ListValue buttonValue;
    private final TickTimer flyTimer;
    private boolean hadGround;
    private final List<Packet> packets;
    private boolean disableLogger;
    private boolean zitter;
    private boolean doTeleport;
    private boolean freeze;
    private TickTimer freezeTimer;
    private int delay;
    private BlockPos endPos;
    private MovingObjectPosition objectPosition;
    
    public Teleport() {
        this.modeValue = new ListValue("Mode", new String[] { "Blink", "Flag", "Rewinside", "OldRewinside", "Spoof", "Minesucht", "AAC3.5.0" }, "Blink");
        this.buttonValue = new ListValue("Button", new String[] { "Left", "Middle", "Right" }, "Middle");
        this.flyTimer = new TickTimer();
        this.packets = new ArrayList<Packet>();
        this.disableLogger = false;
        this.zitter = false;
        this.doTeleport = false;
        this.freeze = false;
        this.freezeTimer = new TickTimer();
        LiquidBounce.CLIENT.commandManager.registerCommand(new Command("teleport", null) {
            @Override
            public void execute(final String[] args) {
                if (args.length <= 1 || !args[1].equalsIgnoreCase("mode")) {
                    this.chatSyntax(".teleport <mode>");
                    return;
                }
                if (args.length > 2 && Teleport.this.modeValue.contains(args[2])) {
                    Teleport.this.modeValue.setValue(args[2].toLowerCase());
                    this.chat("§7Teleport mode was set to §8" + Teleport.this.modeValue.asString().toUpperCase() + "§7.");
                    Teleport$1.mc.getSoundHandler().playSound((ISound)PositionedSoundRecord.create(new ResourceLocation("random.anvil_use"), 1.0f));
                    return;
                }
                this.chatSyntax(".teleport mode §c<§8" + Strings.join(Teleport.this.modeValue.getValues(), "§7, §8") + "§c>");
            }
        });
    }
    
    @Override
    public void onEnable() {
        if (this.modeValue.asString().equalsIgnoreCase("AAC3.5.0")) {
            ChatUtils.displayChatMessage("§c>>> §a§lTeleport §fAAC 3.5.0 §c<<<");
            ChatUtils.displayChatMessage("§cHow to teleport: §aPress " + this.buttonValue.asString() + " mouse button.");
            ChatUtils.displayChatMessage("§cHow to cancel teleport: §aDisable teleport module.");
        }
    }
    
    @Override
    public void onDisable() {
        this.delay = 0;
        this.endPos = null;
        this.hadGround = false;
        this.freeze = false;
        this.disableLogger = false;
        this.flyTimer.reset();
        this.packets.clear();
        super.onDisable();
    }
    
    @EventTarget
    public void onUpdate(final UpdateEvent event) {
        if (!this.modeValue.asString().equals("AAC3.5.0")) {
            if (Teleport.mc.currentScreen == null && Mouse.isButtonDown(MouseUtils.translateButton(this.buttonValue.asString())) && this.delay <= 0) {
                this.endPos = this.objectPosition.getBlockPos();
                if (BlockUtils.getBlock(this.endPos).getMaterial() == Material.air) {
                    this.endPos = null;
                    return;
                }
                ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3Position was set to §8" + this.endPos.getX() + "§3, §8" + (this.endPos.getY() + 1) + "§3, §8" + this.endPos.getZ());
                this.delay = 6;
            }
            if (this.delay > 0) {
                --this.delay;
            }
            if (this.endPos != null) {
                final double endX = this.endPos.getX() + 0.5;
                final double endY = this.endPos.getY() + 1.0;
                final double endZ = this.endPos.getZ() + 0.5;
                final String lowerCase = this.modeValue.asString().toLowerCase();
                switch (lowerCase) {
                    case "blink": {
                        if (Teleport.mc.thePlayer.isSneaking()) {
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C0BPacketEntityAction((Entity)Teleport.mc.thePlayer, C0BPacketEntityAction.Action.STOP_SNEAKING));
                            final double n2;
                            final double n3;
                            final double n4;
                            PathUtils.findBlinkPath(endX, endY, endZ).forEach(vector3d -> {
                                Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(vector3d.x, vector3d.y, vector3d.z, true));
                                Teleport.mc.thePlayer.setPosition(n2, n3, n4);
                                return;
                            });
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C0BPacketEntityAction((Entity)Teleport.mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING));
                            ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8" + endX + "§3, §8" + endY + "§3, §8" + endZ);
                            break;
                        }
                        break;
                    }
                    case "flag": {
                        if (Teleport.mc.thePlayer.isSneaking()) {
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C0BPacketEntityAction((Entity)Teleport.mc.thePlayer, C0BPacketEntityAction.Action.STOP_SNEAKING));
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ, true));
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(endX, endY, endZ, true));
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ, true));
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY + 5.0, Teleport.mc.thePlayer.posZ, true));
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(endX, endY, endZ, true));
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX + 0.5, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ + 0.5, true));
                            MovementUtils.forward(0.04);
                            Teleport.mc.getNetHandler().addToSendQueue((Packet)new C0BPacketEntityAction((Entity)Teleport.mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING));
                            ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8" + endX + "§3, §8" + endY + "§3, §8" + endZ);
                            break;
                        }
                        break;
                    }
                    case "rewinside": {
                        Teleport.mc.thePlayer.motionY = 0.1;
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(endX, endY, endZ, true));
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY + 0.6, Teleport.mc.thePlayer.posZ, true));
                        if ((int)Teleport.mc.thePlayer.posX == (int)endX && (int)Teleport.mc.thePlayer.posY == (int)endY && (int)Teleport.mc.thePlayer.posZ == (int)endZ) {
                            ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8" + endX + "§3, §8" + endY + "§3, §8" + endZ);
                            this.endPos = null;
                            break;
                        }
                        ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3Teleport try...");
                        break;
                    }
                    case "oldrewinside": {
                        Teleport.mc.thePlayer.motionY = 0.1;
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ, true));
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(endX, endY, endZ, true));
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ, true));
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ, true));
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(endX, endY, endZ, true));
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY, Teleport.mc.thePlayer.posZ, true));
                        if ((int)Teleport.mc.thePlayer.posX == (int)endX && (int)Teleport.mc.thePlayer.posY == (int)endY && (int)Teleport.mc.thePlayer.posZ == (int)endZ) {
                            ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8" + endX + "§3, §8" + endY + "§3, §8" + endZ);
                            this.endPos = null;
                        }
                        else {
                            ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3Teleport try...");
                        }
                        MovementUtils.forward(0.04);
                        break;
                    }
                    case "minesucht": {
                        if (!Teleport.mc.thePlayer.isSneaking()) {
                            break;
                        }
                        Teleport.mc.getNetHandler().addToSendQueue((Packet)new C03PacketPlayer.C04PacketPlayerPosition(endX, endY, endZ, true));
                        ChatUtils.displayChatMessage("§7[§8§lTeleport§7] §3You were teleported to §8" + endX + "§3, §8" + endY + "§3, §8" + endZ);
                        break;
                    }
                }
            }
            return;
        }
        this.freezeTimer.update();
        if (this.freeze && this.freezeTimer.hasTimePassed(40)) {
            this.freezeTimer.reset();
            this.setState(this.freeze = false);
        }
        if (!this.flyTimer.hasTimePassed(60)) {
            this.flyTimer.update();
            if (Teleport.mc.thePlayer.onGround) {
                Teleport.mc.thePlayer.jump();
            }
            else {
                MovementUtils.forward(this.zitter ? -0.21 : 0.21);
                this.zitter = !this.zitter;
            }
            this.hadGround = false;
            return;
        }
        if (Teleport.mc.thePlayer.onGround) {
            this.hadGround = true;
        }
        if (!this.hadGround) {
            return;
        }
        if (Teleport.mc.thePlayer.onGround) {
            Teleport.mc.thePlayer.setPositionAndUpdate(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY + 0.2, Teleport.mc.thePlayer.posZ);
        }
        final float vanillaSpeed = 2.0f;
        Teleport.mc.thePlayer.capabilities.isFlying = false;
        Teleport.mc.thePlayer.motionY = 0.0;
        Teleport.mc.thePlayer.motionX = 0.0;
        Teleport.mc.thePlayer.motionZ = 0.0;
        if (Teleport.mc.gameSettings.keyBindJump.isKeyDown()) {
            final EntityPlayerSP thePlayer = Teleport.mc.thePlayer;
            thePlayer.motionY += 2.0;
        }
        if (Teleport.mc.gameSettings.keyBindSneak.isKeyDown()) {
            final EntityPlayerSP thePlayer2 = Teleport.mc.thePlayer;
            thePlayer2.motionY -= 2.0;
        }
        MovementUtils.strafe(2.0f);
        if (Mouse.isButtonDown(MouseUtils.translateButton(this.buttonValue.asString())) && !this.doTeleport) {
            Teleport.mc.thePlayer.setPositionAndUpdate(Teleport.mc.thePlayer.posX, Teleport.mc.thePlayer.posY - 11.0, Teleport.mc.thePlayer.posZ);
            this.disableLogger = true;
            this.packets.forEach(packet -> Teleport.mc.getNetHandler().addToSendQueue(packet));
            this.freezeTimer.reset();
            this.freeze = true;
        }
        this.doTeleport = Mouse.isButtonDown(MouseUtils.translateButton(this.buttonValue.asString()));
    }
    
    @EventTarget
    public void onRender3D(final Render3DEvent event) {
        if (this.modeValue.asString().equals("AAC3.5.0")) {
            return;
        }
        this.objectPosition = Teleport.mc.thePlayer.rayTrace(1000.0, event.getPartialTicks());
        if (this.objectPosition.getBlockPos() == null) {
            return;
        }
        final int x = this.objectPosition.getBlockPos().getX();
        final int y = this.objectPosition.getBlockPos().getY();
        final int z = this.objectPosition.getBlockPos().getZ();
        if (!(BlockUtils.getBlock(this.objectPosition.getBlockPos()) instanceof BlockAir)) {
            final RenderManager renderManager = Teleport.mc.getRenderManager();
            GL11.glBlendFunc(770, 771);
            GL11.glEnable(3042);
            GL11.glLineWidth(2.0f);
            GL11.glDisable(3553);
            GL11.glDisable(2929);
            GL11.glDepthMask(false);
            RenderUtils.glColor((this.modeValue.asString().equalsIgnoreCase("minesucht") && Teleport.mc.thePlayer.getPosition().getY() != y + 1) ? new Color(255, 0, 0, 90) : ((BlockUtils.getBlock(this.objectPosition.getBlockPos().up()).getMaterial() != Material.air) ? new Color(255, 0, 0, 90) : new Color(0, 255, 0, 90)));
            RenderUtils.drawFilledBox(new AxisAlignedBB(x - renderManager.renderPosX, y + 1 - renderManager.renderPosY, z - renderManager.renderPosZ, x - renderManager.renderPosX + 1.0, y + 1.2 - renderManager.renderPosY, z - renderManager.renderPosZ + 1.0));
            GL11.glEnable(3553);
            GL11.glEnable(2929);
            GL11.glDepthMask(true);
            GL11.glDisable(3042);
            RenderUtils.renderNameTag(Math.round(Teleport.mc.thePlayer.getDistance((double)x, (double)y, (double)z)) + "m", x + 0.5, y + 1.7, z + 0.5);
            GlStateManager.resetColor();
        }
    }
    
    @EventTarget
    public void onMove(final MoveEvent event) {
        if ("aac3.5.0".equals(this.modeValue.asString().toLowerCase()) && this.freeze) {
            final double n = 0.0;
            event.z = n;
            event.x = n;
        }
    }
    
    @EventTarget
    public void onPacket(final PacketEvent event) {
        final Packet packet = event.getPacket();
        if (this.disableLogger) {
            return;
        }
        if (packet instanceof C03PacketPlayer) {
            final C03PacketPlayer packetPlayer = (C03PacketPlayer)packet;
            final String lowerCase = this.modeValue.asString().toLowerCase();
            switch (lowerCase) {
                case "spoof": {
                    if (this.endPos == null) {
                        break;
                    }
                    packetPlayer.x = this.endPos.getX() + 0.5;
                    packetPlayer.y = this.endPos.getY() + 1;
                    packetPlayer.z = this.endPos.getZ() + 0.5;
                    Teleport.mc.thePlayer.setPosition(this.endPos.getX() + 0.5, (double)(this.endPos.getY() + 1), this.endPos.getZ() + 0.5);
                    break;
                }
                case "aac3.5.0": {
                    if (!this.flyTimer.hasTimePassed(60)) {
                        return;
                    }
                    event.setCancelled(true);
                    if (!(packet instanceof C03PacketPlayer.C04PacketPlayerPosition) && !(packet instanceof C03PacketPlayer.C06PacketPlayerPosLook)) {
                        return;
                    }
                    this.packets.add(packet);
                    break;
                }
            }
        }
    }
    
    @Override
    public String getTag() {
        return this.modeValue.asString();
    }
}
